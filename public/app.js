!function(){"use strict";var e="undefined"==typeof global?self:global;if("function"!=typeof e.require){var t={},i={},s={},a={}.hasOwnProperty,r=/^\.\.?(\/|$)/,n=function(e,t){for(var i,s=[],a=(r.test(t)?e+"/"+t:t).split("/"),n=0,o=a.length;n<o;n++)i=a[n],".."===i?s.pop():"."!==i&&""!==i&&s.push(i);return s.join("/")},o=function(e){return e.split("/").slice(0,-1).join("/")},h=function(t){return function(i){var s=n(o(t),i);return e.require(s,t)}},l=function(e,t){var s=b&&b.createHot(e),a={id:e,exports:{},hot:s};return i[e]=a,t(a.exports,h(e),a),a.exports},d=function(e){return s[e]?d(s[e]):e},c=function(e,t){return d(n(o(e),t))},u=function(e,s){null==s&&(s="/");var r=d(e);if(a.call(i,r))return i[r].exports;if(a.call(t,r))return l(r,t[r]);throw new Error("Cannot find module '"+e+"' from '"+s+"'")};u.alias=function(e,t){s[t]=e};var g=/\.[^.\/]+$/,p=/\/index(\.[^\/]+)?$/,m=function(e){if(g.test(e)){var t=e.replace(g,"");a.call(s,t)&&s[t].replace(g,"")!==t+"/index"||(s[t]=e)}if(p.test(e)){var i=e.replace(p,"");a.call(s,i)||(s[i]=e)}};u.register=u.define=function(e,s){if(e&&"object"==typeof e)for(var r in e)a.call(e,r)&&u.register(r,e[r]);else t[e]=s,delete i[e],m(e)},u.list=function(){var e=[];for(var i in t)a.call(t,i)&&e.push(i);return e};var b=e._hmr&&new e._hmr(c,u,t,i);u._cache=i,u.hmr=b&&b.wrap,u.brunch=!0,e.require=u}}(),function(){"undefined"==typeof window?this:window;require.register("initialize.js",function(e,t,i){var s=window.GAME=new Phaser.Game({height:630,renderer:Phaser.AUTO,width:800});s.global={inputDevice:"keyboard_touch",currentUser:{},currentUserCalibration:{min:0,max:0},pressureEffort:null,primaryColorHex:"#2cb2ed",primaryColorTint:2929389,titlePlacement:{x:400,y:170},titleStyle:{fill:"white",font:"60px Patua One"},bodyStyle:{fill:"#FFF",font:"20px Open Sans"},bodyStyleError:{fill:"#F00",font:"20px Open Sans",fontWeight:"bold"},buttonLabelStyle:{font:"20px Open Sans",align:"center"},scoreTextStyle:{font:"bold 24px Arial",fill:"#000"},otherPlayersRankingStyle:{font:"22px Open Sans",fill:"white"},currentPlayerRankingStyle:{font:"22px Open Sans",fill:"#2cb2ed",fontWeight:"bold"}},s.state.add("boot",t("states/boot")),s.state.add("menu",t("states/menu")),s.state.add("login",t("states/login")),s.state.add("signup",t("states/signup")),s.state.add("welcome",t("states/welcome")),s.state.add("ranking",t("states/ranking")),s.state.add("settings",t("states/settings")),s.state.add("calibration1",t("states/calibration1")),s.state.add("calibration2",t("states/calibration2")),s.state.add("training_level",t("states/training_level")),s.state.add("game",t("states/game")),s.state.start("boot")}),require.register("states/boot.js",function(e,t,i){i.exports={init:function(){this.input.maxPointers=1,this.game.renderer.renderSession.roundPixels=!0,this.tweens.frameBased=!0,this.whitePixel=this.add.bitmapData(1,1),this.whitePixel.fill(255,255,255),this.bar=this.whitePixel.addToWorld(),this.bar.width=100,this.bar.height=10,this.bar.alignIn(this.world.bounds,Phaser.CENTER),this.add.plugin(PhaserInput.Plugin),WebFontConfig={google:{families:["Open Sans","Patua One"]}}},preload:function(){this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.setScreenSize=!0,this.scale.pageAlignHorizontally=!0,this.scale.pageAlignVertically=!0,this.forceSingleUpdate=!0,this.load.script("webfont","//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"),this.load.atlasJSONHash("button","assets/sprites/button.png","assets/sprites/button.json"),this.load.image("gear","assets/sprites/gear.png"),this.load.image("leaderboard","assets/sprites/leaderboardsComplex.png"),this.load.image("arrowBack","assets/sprites/arrowLeft.png"),this.load.image("bar","assets/sprites/bar.png"),this.load.setPreloadSprite(this.bar),this.load.image("background","assets/sprites/bg_desert.png"),this.load.image("background_menu","assets/sprites/forest_bg.png"),this.load.spritesheet("duck","assets/sprites/chick.png",16,18),this.load.spritesheet("coin","assets/sprites/coin.png",32,32),this.load.image("heartFull","assets/sprites/hud_heartFull.png"),this.load.image("heartEmpty","assets/sprites/hud_heartEmpty.png"),this.load.image("overlay","assets/sprites/overlay.png"),this.load.image("pauseButton","assets/sprites/pause_button.png"),this.load.image("mouth","assets/sprites/mouth.png"),this.load.image("nose","assets/sprites/nose.png"),this.load.image("arrowUp","assets/sprites/arrowUp.png"),this.load.image("arrowDown","assets/sprites/arrowDown.png"),this.load.spritesheet("bee","assets/sprites/bee.png",56,48),this.load.tilemap("tilemap_training","assets/tilemaps/training_level.json",null,Phaser.Tilemap.TILED_JSON),this.load.image("tiles","assets/tilemaps/tiles_spritesheet.png"),this.load.image("arrows_tiles","assets/sprites/arrowSpreadsheet.png"),this.load.image("bee_tiles","assets/sprites/bee.png"),this.load.audio("song",["assets/audio/song.mp3","assets/audio/song.ogg"]),this.load.audio("beethoven","assets/audio/beethoven_crossfade_v4.mp3")},create:function(){this.state.start("menu")},shutdown:function(){this.whitePixel.destroy(),this.whitePixel=null}}}),require.register("states/calibration1.js",function(e,t,i){i.exports={create:function(){var e=(this.add.sprite(0,0,"background_menu"),this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Calibration",this.game.global.titleStyle));e.anchor.set(.5);var t=this.gameInstruction=this.add.text(this.world.centerX,.4*this.world.height,"In the next screen, you can blow out and in as many times\nyou like. Once satisfied, press the Done button to save the calibration.",this.game.global.bodyStyle);t.anchor.setTo(.5);var i=this.keyTouchBtn=this.add.sprite(.5*this.world.width,.6*this.world.height,"button","blue_button04.png");i.anchor.set(.5,.5),i.inputEnabled=!0,i.input.useHandCursor=!0;var s=this.add.text(0,0,"Start calibration",this.game.global.buttonLabelStyle);s.anchor.set(.5,.5),i.addChild(s),i.events.onInputDown.add(function(){this.state.start("calibration2")},this)}}}),require.register("states/calibration2.js",function(e,t,i){i.exports={create:function(){var e=this,t=this.pressure=null;this.averagePressure=0,this.pressureCount=0,this.numMeasurements=50,this.updatedCircleDiameter=0,this.game.global.currentUserCalibration.min=0,this.game.global.currentUserCalibration.max=0;var i=(this.add.sprite(0,0,"background_menu"),this.arrowBack=this.add.image(50,50,"arrowBack"));i.anchor.set(.5,.5),i.scale.setTo(.6,.6),i.tint=this.game.global.primaryColorTint,i.inputEnabled=!0,i.input.useHandCursor=!0,i.events.onInputDown.add(function(){e.state.start("settings")},this),this.socket=io.connect(window.location.hostname,{secure:!0,reconnect:!0,rejectUnauthorized:!1}),this.socket.on("connect",function(){console.log("client (game) connected to server")}),this.socket.on("pc",function(i){e.pressure=parseFloat(i.p),console.log("pressure received: "+parseFloat(t)),e.pressureCount<e.numMeasurements&&(console.log("self.averagePressure prima: "+e.averagePressure),e.averagePressure+=e.pressure,console.log("self.averagePressure dopo: "+e.averagePressure),e.pressureCount++),e.pressureCount===e.numMeasurements&&(e.averagePressure/=e.pressureCount,console.log("self.averagePressure divisione: "+e.averagePressure),e.pressureCount++),e.updatedCircleDiameter=Phaser.Math.mapLinear(e.pressure,-2e3,1500,30,250)});var s=this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Calibration",this.game.global.titleStyle);s.anchor.set(.5),this.largerCircle=new Phaser.Circle(this.world.centerX,this.world.centerY,100),this.graphics=this.add.graphics(0,0),this.maxCircle=this.add.graphics(0,0),this.minCircle=this.add.graphics(0,0),this.breathingSensorCircle=this.add.graphics(0,0),this.breathingSensorCircle.beginFill(16711680,1),this.breathingSensorCircle.drawCircle(this.camera.width-300,40,25),this.breathingSensorText=this.add.text(this.camera.width-170,42,"Device not connected",this.game.global.bodyStyle),this.breathingSensorText.anchor.set(.5);var a=this.keyTouchBtn=this.add.sprite(.5*this.camera.width,.8*this.camera.height,"button","blue_button04.png");a.anchor.set(.5,.5),a.inputEnabled=!0,a.input.useHandCursor=!0;var r=this.add.text(0,0,"Done!",this.game.global.buttonLabelStyle);r.anchor.set(.5,.5),a.addChild(r),a.events.onInputDown.add(function(){e.saveDataToDb(),e.goToPreviousState()},this)},update:function(){this.updateSensorStatus(),this.pressureCount>=this.numMeasurements&&(console.log("> 50"),console.log("actual pressure: "+this.pressure+", average: "+this.averagePressure),(this.pressure>this.averagePressure+20||this.pressure<this.averagePressure-20)&&(console.log("outside average range"),this.pressure>this.game.global.currentUserCalibration.max?(console.log("update max"),this.game.global.currentUserCalibration.max=this.pressure,this.maxCircle.clear(),this.maxCircle.lineStyle(5,255,1),this.maxCircle.drawCircle(this.world.centerX,this.world.centerY,Phaser.Math.mapLinear(this.game.global.currentUserCalibration.max,-2e3,1500,30,250))):this.pressure<this.game.global.currentUserCalibration.min&&(console.log("update min"),this.game.global.currentUserCalibration.min=this.pressure,this.minCircle.clear(),this.minCircle.lineStyle(5,52479,1),this.minCircle.drawCircle(this.world.centerX,this.world.centerY,Phaser.Math.mapLinear(this.game.global.currentUserCalibration.min,-2e3,1500,30,250))))),this.largerCircle.diameter=this.updatedCircleDiameter,this.graphics.clear(),this.graphics.beginFill(this.game.global.primaryColorTint,.5),this.graphics.drawCircle(this.world.centerX,this.world.centerY,this.largerCircle.diameter)},saveDataToDb:function(){var e=new XMLHttpRequest;e.open("POST","https://duckieduck.herokuapp.com/api/calibrations",!0),e.setRequestHeader("Content-Type","application/json;charset=UTF-8");var t=JSON.stringify({userId:this.game.global.currentUser.id,max_inhale:this.game.global.currentUserCalibration.min,max_exhale:this.game.global.currentUserCalibration.max});e.send(t)},goToPreviousState:function(){this.state.start("settings")},updateSensorStatus:function(){null!==this.pressure?(this.breathingSensorCircle.clear(),this.breathingSensorCircle.beginFill(65280,1),this.breathingSensorCircle.drawCircle(this.camera.width-300,40,25),this.breathingSensorText.setText("Device is connected!")):(this.breathingSensorCircle.clear(),this.breathingSensorCircle.beginFill(16711680,1),this.breathingSensorCircle.drawCircle(this.camera.width-300,40,25),this.breathingSensorText.setText("Device not connected!"))}}}),require.register("states/game.js",function(e,t,i){i.exports={create:function(){var e=this.world,t=this;this.speed=3;this.music=null,this.gameIsStopped=!1,this.pressure=null,this.rankingRetrieved=!1,this.scoreUpdated=!1,"breath"===this.game.global.inputDevice&&(this.socket=io.connect(window.location.hostname,{secure:!0,reconnect:!0,rejectUnauthorized:!1}),this.socket.on("connect",function(){console.log("client (game) connected to server"),t.socket.on("pc",function(e){t.pressure=parseFloat(e.p)})})),this.time.events.add(7.8*Phaser.Timer.SECOND,function(){t.music=t.sound.play("beethoven")},this),this.score=0,this.health=60,this.coinValue=10,this.gameOver=!1,this.physics.startSystem(Phaser.Physics.ARCADE),this.physics.arcade.gravity.y=500,this.enableCollision=!0;var i=this.background=this.add.tileSprite(0,0,e.width,e.height,"background");i.fixedToCamera=!0,this.map=this.game.add.tilemap("tilemap_training"),this.map.addTilesetImage("tiles_spritesheet","tiles"),this.map.addTilesetImage("Enemy","bee_tiles");var s=(this.scenarioLayer=this.map.createLayer("Scenario"),this.groundLayer=this.map.createLayer("Ground")),a=this.underwaterLayer=this.map.createLayer("Underwater");a.alpha=.7;this.specialBoxesLayer=this.map.createLayer("SpecialBoxes");this.map.setCollisionBetween(1,133,!0,"Scenario"),this.map.setCollisionBetween(1,153,!0,"Underwater"),this.map.setCollisionBetween(1,25,!0,"SpecialBoxes"),this.enemies=this.add.group(),this.enemies.enableBody=!0,this.map.createFromObjects("Enemies",157,"bee",0,!0,!1,this.enemies),this.enemies.callAll("animations.add","animations","fly",[0,2],10,!0),this.enemies.callAll("animations.play","animations","fly"),this.enemies.callAll("animations.add","animations","dead",[1],10,!0),this.enemies.setAll("body.allowGravity",!1),this.enemies.setAll("checkWorldBounds",!0),this.enemies.setAll("outOfBoundsKill",!0),this.enemies.forEach(function(e){t.add.tween(e.scale).to({x:1.2,y:1.2},480,Phaser.Easing.Back.InOut,!0,0,!1)}),this.coins=this.add.group(),this.coins.enableBody=!0,this.map.createFromObjects("Coins",161,"coin",0,!0,!1,this.coins),this.coins.callAll("animations.add","animations","spin",[0,1,2,3,4,5],10,!0),this.coins.callAll("animations.play","animations","spin"),this.coins.setAll("body.allowGravity",!1),this.scoreText=this.add.text(400,40,"score: 0",this.game.global.scoreTextStyle),this.scoreText.anchor.setTo(.5,.5),this.scoreText.fixedToCamera=!0,this.infoText=this.add.text(.5*this.camera.width,.3*this.camera.height,"Special boxes"),this.infoText.anchor.setTo(.5,.5),this.infoText.visible=!1,this.infoText.fixedToCamera=!0;var r=this.mouth=this.add.sprite(.4*this.camera.width,.4*this.world.height,"mouth");r.scale.setTo(.15,.15),r.anchor.setTo(.5,.5),r.fixedToCamera=!0;var n=this.nose=this.add.sprite(.4*this.camera.width,.52*this.world.height,"nose");n.scale.setTo(.15,.15),n.anchor.setTo(.5,.5),n.fixedToCamera=!0,this.mouthText=this.add.text(.56*this.camera.width,.4*this.world.height,"Jump and fly",{align:"left",boundsAlignH:"left",boundsAlignV:"middle"}),this.mouthText.anchor.setTo(.5,.5),this.mouthText.fixedToCamera=!0,this.noseText=this.add.text(.58*this.camera.width,.52*this.world.height,"Go under water",{align:"left",boundsAlignH:"left",boundsAlignV:"middle"}),this.noseText.anchor.setTo(.5,.5),this.noseText.fixedToCamera=!0,this.time.events.add(5*Phaser.Timer.SECOND,function(){this.switchAlphaInstructions([this.mouth,this.nose,this.mouthText,this.noseText])},this),this.hearts=this.add.group();for(var o=0;o<6;o++)this.hearts.create(50+45*o,40,"heartFull");this.hearts.forEach(function(e){e.anchor.setTo(.5,.5),e.scale.setTo(.7,.7)}),this.hearts.fixedToCamera=!0,this.breathingSensorCircle=this.add.graphics(0,0),this.breathingSensorCircle.beginFill(16711680,1),this.breathingSensorCircle.drawCircle(this.camera.width-100,40,25),this.breathingSensorCircle.fixedToCamera=!0,this.overlayBackground=this.add.sprite(0,0,"overlay"),this.overlayBackground.x=.5*this.camera.width,this.overlayBackground.y=.5*this.camera.height,this.overlayBackground.anchor.set(.5,.5),this.overlayBackground.fixedToCamera=!0,this.overlayBackground.visible=!1,this.overlayText=this.add.text(.5*this.camera.width,100,"Text goes here",{align:"center",font:"bold 28px Arial",fill:"#fff"}),this.overlayText.anchor.set(.5,.5),this.overlayText.fixedToCamera=!0,this.overlayText.visible=!1,this.backToMenuPauseBtn=this.add.sprite(.5*this.camera.width,.65*this.camera.height,"button","blue_button04.png"),this.backToMenuPauseBtn.anchor.set(.5),this.backToMenuPauseBtn.inputEnabled=!0,this.backToMenuPauseBtn.input.useHandCursor=!0,this.backToMenuPauseBtn.visible=!1,this.backToMenuPauseText=this.add.text(0,0,"Back to main menu",this.game.global.buttonLabelStyle),this.backToMenuPauseText.anchor.set(.5),this.backToMenuPauseBtn.addChild(this.backToMenuPauseText),this.backToMenuPauseBtn.fixedToCamera=!0,this.backToMenuPauseBtn.events.onInputUp.add(function(){t.stopEverything(),t.state.start("welcome")}),this.playAgainBtn=this.add.sprite(.65*this.camera.width,.85*this.camera.height,"button","blue_button04.png"),this.playAgainBtn.anchor.set(.5),this.playAgainBtn.inputEnabled=!0,this.playAgainBtn.input.useHandCursor=!0,this.playAgainBtn.visible=!1,this.okBtnText=this.add.text(0,0,"Play again",this.game.global.buttonLabelStyle),this.okBtnText.anchor.set(.5),this.playAgainBtn.addChild(this.okBtnText),this.playAgainBtn.fixedToCamera=!0,this.playAgainBtn.events.onInputUp.add(function(){t.switchAlphaInstructions([t.mouth,t.nose,t.mouthText,t.noseText]),t.state.restart()}),this.backToMenuBtn=this.add.sprite(.35*this.camera.width,.85*this.camera.height,"button","blue_button04.png"),this.backToMenuBtn.anchor.set(.5),this.backToMenuBtn.inputEnabled=!0,this.backToMenuBtn.input.useHandCursor=!0,this.backToMenuBtn.visible=!1,this.backToMenuText=this.add.text(0,0,"Back to Menu",this.game.global.buttonLabelStyle),this.backToMenuText.anchor.set(.5),this.backToMenuBtn.addChild(this.backToMenuText),this.backToMenuBtn.fixedToCamera=!0,this.backToMenuBtn.events.onInputUp.add(function(){t.state.start("welcome")}),this.pauseButton=this.add.image(this.camera.width-40,40,"pauseButton"),this.pauseButton.scale.setTo(.1,.1),this.pauseButton.anchor.setTo(.5,.5),this.pauseButton.inputEnabled=!0,this.pauseButton.fixedToCamera=!0,this.pauseButton.events.onInputUp.add(function(){t.gameIsStopped?(t.displayOverlay("resumeGame"),t.gameIsStopped=!1):(t.displayOverlay("pause"),t.gameIsStopped=!0)});var h=this.endGameWall=this.add.sprite(this.world.width,0);this.physics.arcade.enable(h),h.body.collideWorldBounds=!0,h.width=10,h.height=this.world.height;var l=this.duck=this.add.sprite(80,e.centerY+60,"duck");l.anchor.setTo(.5,.5),this.physics.arcade.enable(l),l.body.collideWorldBounds=!0,l.scale.set(2),l.animations.add("walk",null,5,!0),l.animations.play("walk"),l.body.allowDrag=!0,l.body.drag.set(0,100),l.body.maxVelocity.set(200,400),this.camera.follow(l),this.camera.deadzone=new Phaser.Rectangle(0,0,100,400),"breath"===this.game.global.inputDevice&&(this.breathingBar=this.add.sprite(50,e.centerY,"bar"),this.breathingBar.anchor.set(0,.5),this.breathingBar.angle=90,this.breathingBar.scale.set(.2),this.breathingBar.fixedToCamera=!0,this.barHasBeenFlipped=!1);var d=this.add.text(80,.4*e.centerY,"Almost there! :)");d.anchor.set(.5);var c=this.duck2=this.add.sprite(80,.5*e.centerY,"duck");if(c.anchor.set(.5),c.scale.set(3),this.duckBounceTween(c),s.resizeWorld(),h.x=.97*this.world.width,d.x=.69*this.world.width,c.x=.69*this.world.width,"keyboard_touch"===this.game.global.inputDevice){var u=this.cursors=this.input.keyboard.createCursorKeys();u.down.onDown.add(function(){t.jump()}),u.up.onDown.add(function(){t.dive()}),this.swipe=this.game.input.activePointer}var g=this.highScoreBeaten=this.add.text(0,0,"inform user",this.game.global.bodyStyle);g.anchor.set(.5),g.visible=!1},update:function(){this.duck.body.velocity.x=60*this.speed,this.floatingWaterPhysics(),"breath"===this.game.global.inputDevice&&(this.updateSensorStatus(),this.updateBreathingBar()),this.gameOver?this.displayOverlay("gameOver"):this.background.tilePosition.x-=this.speed,this.physics.arcade.collide(this.duck,[this.scenarioLayer,this.underwaterLayer,this.enemies],this.duckCollision,this.duckProcessCallback,this),this.physics.arcade.collide(this.duck,this.specialBoxesLayer,this.hitSpecialBoxes,null,this),this.physics.arcade.overlap(this.duck,this.endGameWall,this.endGame,null,this),this.duck.y>this.world.centerY+60?this.duck.alpha=.3:this.duck.alpha=1,this.physics.arcade.overlap(this.duck,this.coins,this.collectCoin,null,this),"keyboard_touch"===this.game.global.inputDevice?(this.swipe.isDown&&this.swipe.positionDown.y>this.swipe.position.y?this.jump():this.swipe.isDown&&this.swipe.positionDown.y<this.swipe.position.y&&this.dive(),this.cursors.up.isDown?this.duck.body.acceleration.y=-1e3:this.cursors.down.isDown?this.duck.body.acceleration.y=800:this.duck.body.acceleration.y=0):"breath"===this.game.global.inputDevice?(this.pressure<this.game.global.currentUserCalibration.min*this.game.global.pressureEffort&&this.jump(),this.pressure>this.game.global.currentUserCalibration.max*this.game.global.pressureEffort&&this.dive(),this.pressure>this.game.global.currentUserCalibration.max*this.game.global.pressureEffort?this.duck.body.acceleration.y=-1e3:this.pressure<this.game.global.currentUserCalibration.min*this.game.global.pressureEffort?this.duck.body.acceleration.y=800:this.duck.body.acceleration.y=0):alert("Error in setting the input device, reload and check game settings!")},quit:function(){this.state.start("welcome")},duckProcessCallback:function(e,t){return this.enableCollision},duckCollision:function(e,t){if("bee"===t.key&&(t.animations.play("dead",10,!0),t.body.allowGravity=!0),e.body.blocked.down||e.body.blocked.up)console.log("Collision from above/below");else{this.health-=10,this.enableCollision=!1,this.duck.tint=16724787,this.add.tween(this.duck).to({angle:1440},1e3,Phaser.Easing.Linear.None,!0),this.add.tween(this.duck.scale).to({x:3,y:3},500,Phaser.Easing.Linear.None,!0).yoyo(!0);for(var i=this.hearts.length-1;i>0;i--){var s=this.hearts.getAt(i);if("heartFull"===s.key){s.loadTexture("heartEmpty");break}}0===this.health&&(this.gameOver=!0),this.time.events.add(3*Phaser.Timer.SECOND,this.resetPlayer,this)}},jump:function(){this.duck.body.y>this.world.centerY-35&&this.duck.body.y<this.world.height-70&&(this.duck.body.velocity.y=325)},dive:function(){this.duck.body.y<=this.world.centerY+60&&this.duck.body.y>100&&(this.duck.body.velocity.y=-325)},resetPlayer:function(){this.duck.tint=16777215,this.enableCollision=!0},collectCoin:function(e,t){this.score+=this.coinValue,this.scoreText.setText("score: "+this.score),t.destroy()},hitSpecialBoxes:function(e,t){var i=this;this.map.removeTile(t.x,t.y,this.specialBoxesLayer).destroy();var s=this.rnd.between(0,100);if(s>50)for(var a=0;a<this.hearts.length;a++){var r=this.hearts.getAt(a);if("heartEmpty"===r.key){r.loadTexture("heartFull"),this.health+=10,this.showAndRemoveText(this.infoText,"One heart recovered!");break}a===this.hearts.length-1&&this.showAndRemoveText(this.infoText,"Already had max health!")}else this.coinValue=20,this.time.events.add(5*Phaser.Timer.SECOND,function(){i.coinValue=10},this),this.showAndRemoveText(this.infoText,"All coins are double value for 5 seconds!"),this.coins.forEach(function(e){i.add.tween(e.scale).to({x:1.5,y:1.5},500,Phaser.Easing.Quadratic.InOut,!0)}),this.time.events.add(5*Phaser.Timer.SECOND,function(){this.coins.forEach(function(e){i.add.tween(e.scale).to({x:1,y:1},500,Phaser.Easing.Quadratic.InOut,!0)})},this)},showAndRemoveText:function(e,t){e.x=.5*this.camera.width,e.y=.3*this.camera.height,e.setText(t),e.visible=!0,this.time.events.add(5*Phaser.Timer.SECOND,function(){e.visible=!1},this)},switchAlphaInstructions:function(e){for(var t=0;t<e.length;t++)this.add.tween(e[t]).to({alpha:0},500,"Linear",!0)},displayOverlay:function(e){var t=this;switch(this.overlayBackground.visible=!0,this.overlayText.visible=!0,this.stopEverything(),e){case"pause":this.overlayText.setText("Game paused, click the pause button to resume."),this.backToMenuPauseBtn.visible=!0;break;case"gameOver":this.overlayText.setText("Great job! Play again?"),this.playAgainBtn.visible=!0,this.backToMenuBtn.visible=!0,this.saveScoreOnDb().then(function(e){console.log("promise reply: "+e),t.getRankingFromDb()});break;case"gameEnd":this.overlayText.setText("Well done! Play again?"),this.playAgainBtn.visible=!0,this.backToMenuBtn.visible=!0,this.saveScoreOnDb().then(function(e){console.log("promise reply: "+e),t.getRankingFromDb()});break;case"resumeGame":null!==this.music&&this.music.resume(),this.paused=!1,this.physics.arcade.isPaused=!this.physics.arcade.isPaused,this.overlayBackground.visible=!1,this.overlayText.visible=!1,this.backToMenuPauseBtn.visible=!1;break;default:console.log("You are not supposed to be here...")}},stopEverything:function(){this.physics.arcade.isPaused=!0,this.paused=!0,null!==this.music&&this.music.isPlaying&&this.music.pause()},getRankingFromDb:function(){var e=this;if(console.log("Inside the getRankingFromDb function"),!this.rankingRetrieved){this.rankingRetrieved=!0;var t=new XMLHttpRequest;t.open("GET","https://duckieduck.herokuapp.com/api/users",!0),t.onload=function(){var i=JSON.parse(t.responseText);if(4==t.readyState&&"200"==t.status){console.log("Correctly retrieved data of users for ranking"),i=i.sort(function(e,t){return t.high_score-e.high_score});var s=!1;e.highScoreBeaten.visible=!0,e.highScoreBeaten.x=e.camera.x+.5*e.camera.width,e.highScoreBeaten.y=.26*e.camera.height,e.score>e.game.global.currentUser.high_score?(console.log("Scored higher"),e.highScoreBeaten.setText("You have beaten your own record, congrats! :)")):(console.log("Scored Lower"),e.highScoreBeaten.setText("Nice score! Keep trying to improve it! :)"));for(var a=0;a<i.length;a++)a<=4?i[a].id===e.game.global.currentUser.id?(s=!0,e.add.text(e.camera.x+300,.4*e.camera.height+50*a+1,a+1,e.game.global.currentPlayerRankingStyle).anchor.setTo(.5),e.add.text(e.camera.x+350,.4*e.camera.height+50*a+1,i[a].name,e.game.global.currentPlayerRankingStyle).anchor.setTo(.5),e.add.text(e.camera.x+450,.4*e.camera.height+50*a+1,i[a].high_score,e.game.global.currentPlayerRankingStyle).anchor.setTo(.5)):(e.add.text(e.camera.x+300,.4*e.camera.height+50*a+1,a+1,e.game.global.otherPlayersRankingStyle).anchor.setTo(.5),e.add.text(e.camera.x+350,.4*e.camera.height+50*a+1,i[a].name,e.game.global.otherPlayersRankingStyle).anchor.setTo(.5),e.add.text(e.camera.x+450,.4*e.camera.height+50*a+1,i[a].high_score,e.game.global.otherPlayersRankingStyle).anchor.setTo(.5)):i[a].id!==e.game.global.currentUser.id||s||(e.add.text(e.camera.x+300,.6*e.camera.height,a+1,e.game.global.currentPlayerRankingStyle).anchor.setTo(.5),e.add.text(e.camera.x+350,.6*e.camera.height,i[a].name,e.game.global.currentPlayerRankingStyle).anchor.setTo(.5),e.add.text(e.camera.x+450,.6*e.camera.height,i[a].high_score,e.game.global.currentPlayerRankingStyle).anchor.setTo(.5))}else console.error(i)},t.send(null)}},saveScoreOnDb:function(){var e=this;return new Promise(function(t,i){if(e.score>e.game.global.currentUser.high_score){console.log("Score higher! Saving value in db");var s=new XMLHttpRequest;s.open("PUT","https://duckieduck.herokuapp.com/api/users/"+e.game.global.currentUser.id,!0),s.setRequestHeader("Content-Type","application/json;charset=UTF-8");var a=JSON.stringify({high_score:e.score});s.onload=function(){s.readyState==XMLHttpRequest.DONE&&200==s.status&&(console.log("resolved the savetoDB thingy"),t(s.response))},s.onerror=function(){i(s.statusText)},s.send(a)}else t("showRanking")})},endGame:function(){this.displayOverlay("gameEnd")},updateSensorStatus:function(){null!==this.pressure?(this.breathingSensorCircle.clear(),this.breathingSensorCircle.beginFill(65280,1),this.breathingSensorCircle.drawCircle(this.camera.width-100,40,25)):(this.breathingSensorCircle.clear(),this.breathingSensorCircle.beginFill(16711680,1),this.breathingSensorCircle.drawCircle(this.camera.width-100,40,25))},updateBreathingBar:function(){this.breathingBar.tint=13421772,this.pressure>0?(this.barHasBeenFlipped&&(this.breathingBar.angle=270,this.barHasBeenFlipped=!1),this.breathingBar.width=100*this.pressure/1490,this.pressure>this.game.global.currentUserCalibration.max*this.game.global.pressureEffort&&(this.breathingBar.tint=65280)):(this.breathingBar.angle=90,this.barHasBeenFlipped=!0,this.breathingBar.width=Math.abs(100*this.pressure/-1800),this.pressure<this.game.global.currentUserCalibration.min*this.game.global.pressureEffort&&(this.breathingBar.tint=65280))},duckBounceTween:function(){var e=this;this.duck2.y=.5*this.camera.height+60;var t=this.add.tween(this.duck2);t.to({y:.25*this.camera.height-40},1500+1500*Math.random(),Phaser.Easing.Bounce.In),t.onComplete.add(function(){e.duckBounceTween()},this),t.start()},floatingWaterPhysics:function(){if(this.duck.body.y>this.world.centerY+60)this.physics.arcade.gravity.y=-1200;else if(this.duck.body.y<this.world.centerY+25&&this.duck.body.y>=this.world.centerY+20)this.physics.arcade.gravity.y=0;else if(this.duck.body.y<this.world.centerY+20)this.physics.arcade.gravity.y=1400;else{this.physics.arcade.gravity.y=-120;200*Math.abs(this.duck.body.velocity.y)/400+50}}}}),require.register("states/login.js",function(e,t,i){i.exports={create:function(){var e=this,t=(this.add.sprite(0,0,"background_menu"),this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Login",this.game.global.titleStyle));t.anchor.set(.5);var i=this.arrowBack=this.add.image(50,50,"arrowBack");i.anchor.set(.5,.5),i.scale.setTo(.6,.6),i.tint=this.game.global.primaryColorTint,i.inputEnabled=!0,i.input.useHandCursor=!0,i.events.onInputDown.add(function(){e.state.start("menu")},this),this.nameInput=this.add.inputField(this.world.centerX-140,this.world.centerY-50,{font:"20px Arial",width:250,padding:16,borderWidth:3,borderColor:"#2cc0ff",borderRadius:6,placeHolder:"Name"}),this.passwordInput=this.add.inputField(this.world.centerX-140,this.world.centerY+25,{font:"20px Arial",width:250,padding:16,borderWidth:3,borderColor:"#2cc0ff",borderRadius:6,placeHolder:"Password",type:PhaserInput.InputType.password});var s=this.add.text(this.world.centerX,.9*this.world.height,"Name and/or password not correct, try again!",this.game.global.bodyStyleError);s.anchor.set(.5),s.visible=!1;var a=this.checkLoginBtn=this.add.sprite(this.world.centerX,this.world.centerY+140,"button","blue_button04.png");a.anchor.set(.5,.5),a.inputEnabled=!0,a.input.useHandCursor=!0;var r=this.add.text(0,0,"Login",this.game.global.buttonLabelStyle);r.anchor.set(.5,.5),a.addChild(r),a.events.onInputDown.add(function(){var t=this.nameInput.value,i=this.passwordInput.value;console.log("name: "+t+", pass: "+i);var a=new XMLHttpRequest;a.open("GET","https://duckieduck.herokuapp.com/api/users",!0),a.onload=function(){var r=JSON.parse(a.responseText);if(4==a.readyState&&"200"==a.status){var n=!1;r.forEach(function(s){s.name===t&&s.password===i&&(e.game.global.currentUser=s,e.state.start("welcome"),n=!0)}),n||(s.visible=!0,e.time.events.add(3*Phaser.Timer.SECOND,function(){s.visible=!1},this))}else console.error(r)},a.send(null)},this)},startGame:function(){this.state.start("game")}}}),require.register("states/menu.js",function(e,t,i){i.exports={create:function(){var e=this;this.restartLevel=this.input.keyboard.addKey(Phaser.Keyboard.S),this.restartLevel.onDown.add(function(){e.state.start("game")},this);var t=(this.add.sprite(0,0,"background_menu"),this.add.sprite(-50,250,"duck"));t.anchor.setTo(.5,.5),t.scale.set(2),t.animations.add("walk",null,5,!0),t.animations.play("walk");var i=this.add.tween(t).to({x:[200,400],y:[200,270]},3e3,"Sine.easeInOut");i.start();var s=this.add.text(.5*this.camera.width,-200,"Duckie Duck's Quest",{fill:"white",font:"80px IM Fell English SC"});s.anchor.set(.5),this.add.tween(s).to({y:.5*this.camera.height},2e3,Phaser.Easing.Bounce.Out,!0);var a=this.button=this.add.sprite(this.world.centerX,this.world.centerY+100,"button","blue_button04.png");a.anchor.set(.5,.5),a.inputEnabled=!0,a.input.useHandCursor=!0;var r=this.add.text(0,0,"Login",this.game.global.buttonLabelStyle);r.anchor.set(.5,.5),a.addChild(r),a.events.onInputDown.add(this.loginPage.bind(this),this);var n=this.button=this.add.sprite(this.world.centerX,this.world.centerY+170,"button","blue_button04.png");n.anchor.set(.5,.5),n.inputEnabled=!0,n.input.useHandCursor=!0;var o=this.add.text(0,0,"Signup",this.game.global.buttonLabelStyle);o.anchor.set(.5,.5),n.addChild(o),n.events.onInputDown.add(this.signupPage.bind(this),this)},startGame:function(){this.state.start("game")},loginPage:function(){this.state.start("login")},signupPage:function(){this.state.start("signup")},createText:function(){}}}),require.register("states/ranking.js",function(e,t,i){i.exports={create:function(){var e=this;this.sortedUsers=[];var t=(this.add.sprite(0,0,"background_menu"),this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Ranking",this.game.global.titleStyle));t.anchor.set(.5),this.getRankingFromDb();var i=this.arrowBack=this.add.image(50,50,"arrowBack");i.anchor.set(.5,.5),i.scale.setTo(.6,.6),i.tint=this.game.global.primaryColorTint,i.inputEnabled=!0,i.input.useHandCursor=!0,i.events.onInputDown.add(function(){e.state.start("welcome")},this)},startGame:function(){this.state.start("game")},settingsPage:function(){this.state.start("settings")},getRankingFromDb:function(){
var e=this,t=new XMLHttpRequest;t.open("GET","https://duckieduck.herokuapp.com/api/users",!0),t.onload=function(){var i=JSON.parse(t.responseText);if(console.log("users from db: ",i),4==t.readyState&&"200"==t.status){e.sortedUsers=i.sort(function(e,t){return t.high_score-e.high_score});for(var s=0;s<e.sortedUsers.length;s++)e.sortedUsers[s].id===e.game.global.currentUser.id?(e.add.text(e.camera.x+300,e.game.global.titlePlacement.y+100+50*s+1,s+1,e.game.global.currentPlayerRankingStyle),e.add.text(e.camera.x+350,e.game.global.titlePlacement.y+100+50*s+1,e.sortedUsers[s].name,e.game.global.currentPlayerRankingStyle),e.add.text(e.camera.x+450,e.game.global.titlePlacement.y+100+50*s+1,e.sortedUsers[s].high_score,e.game.global.currentPlayerRankingStyle)):(e.add.text(e.camera.x+300,e.game.global.titlePlacement.y+100+50*s+1,s+1,e.game.global.otherPlayersRankingStyle),e.add.text(e.camera.x+350,e.game.global.titlePlacement.y+100+50*s+1,e.sortedUsers[s].name,e.game.global.otherPlayersRankingStyle),e.add.text(e.camera.x+450,e.game.global.titlePlacement.y+100+50*s+1,e.sortedUsers[s].high_score,e.game.global.otherPlayersRankingStyle))}else console.error(i)},t.send(null)}}}),require.register("states/settings.js",function(e,t,i){i.exports={create:function(){var e=this,t=(this.add.sprite(0,0,"background_menu"),this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Settings",this.game.global.titleStyle));t.anchor.set(.5);var i=this.arrowBack=this.add.image(50,50,"arrowBack");i.anchor.set(.5,.5),i.scale.setTo(.6,.6),i.tint=this.game.global.primaryColorTint,i.inputEnabled=!0,i.input.useHandCursor=!0,i.events.onInputDown.add(function(){e.state.start("welcome")},this);var s=this.add.text(.125*this.camera.width,.6*this.camera.height-100,"Input device",this.game.global.bodyStyle);s.anchor.set(.5);var a=this.keyTouchBtn=this.add.sprite(.45*this.camera.width,.6*this.camera.height-100,"button","blue_button04.png");a.anchor.set(.5,.5),a.alpha=.6,a.inputEnabled=!0,a.input.useHandCursor=!0;var r=this.add.text(0,0,"Keyboard/Touch",this.game.global.buttonLabelStyle);r.anchor.set(.5,.5),a.addChild(r),a.events.onInputDown.add(function(){e.game.global.inputDevice="keyboard_touch",h.visible=!1},this);var n=this.breathingBtn=this.add.sprite(.75*this.camera.width,.6*this.camera.height-100,"button","blue_button04.png");n.anchor.set(.5,.5),n.alpha=.6,n.inputEnabled=!0,n.input.useHandCursor=!0;var o=this.add.text(0,0,"Breath",this.game.global.buttonLabelStyle);o.anchor.set(.5,.5),n.addChild(o),n.events.onInputDown.add(function(){e.game.global.inputDevice="breath",h.visible=!0},this);var h=this.calibrationBtn=this.add.sprite(.75*this.camera.width,.7*this.camera.height-100,"button","blue_button04.png");h.anchor.set(.5,.5),h.inputEnabled=!0,h.input.useHandCursor=!0,h.visible=!1;var l=this.add.text(0,0,"Calibration",this.game.global.buttonLabelStyle);l.anchor.set(.5,.5),h.addChild(l),h.events.onInputDown.add(function(){this.state.start("calibration1")},this),this.thresholdInput=this.add.inputField(.635*this.camera.width,.85*this.camera.height-100,{font:this.game.global.bodyStyle.font,width:150,padding:16,borderWidth:3,borderColor:"#2cc0ff",borderRadius:6,min:"10",max:"100",placeHolder:"Threshold"}),null!==this.game.global.pressureEffort?this.thresholdInput.setText(""+100*this.game.global.pressureEffort):this.thresholdInput.setText("80");var d=this.thresholdLabel=this.add.text(.75*this.camera.width,.82*this.camera.height-100,"Threshold (5-100)",this.game.global.bodyStyle);d.anchor.set(.5);var c=this.saveBtn=this.add.sprite(.5*this.camera.width,.9*this.camera.height,"button","blue_button04.png");c.anchor.set(.5,.5),c.inputEnabled=!0,c.input.useHandCursor=!0;var u=this.add.text(0,0,"Save",this.game.global.buttonLabelStyle);u.anchor.set(.5,.5),c.addChild(u),c.events.onInputDown.add(this.checkInputAndSave,this)},update:function(){this.checkCurrentInputDevice(this.keyTouchBtn,this.breathingBtn)},startGame:function(){this.state.start("game")},settingsPage:function(){this.state.start("settings")},checkCurrentInputDevice:function(e,t){e.alive&&t.alive&&("keyboard_touch"===this.game.global.inputDevice?(e.alpha=1,t.alpha=.6,this.calibrationBtn.visible=!1,this.calibrationBtn.inputEnabled=!1,this.thresholdInput.inputEnabled=!1,this.thresholdInput.alpha=0,this.thresholdLabel.alpha=0):"breath"===this.game.global.inputDevice&&(e.alpha=.6,t.alpha=1,this.calibrationBtn.visible=!0,this.calibrationBtn.inputEnabled=!0,this.thresholdInput.inputEnabled=!0,this.thresholdInput.alpha=1,this.thresholdLabel.alpha=1))},checkInputAndSave:function(){var e=/^[0-9]+$/;if(e.test(this.thresholdInput.value)&&(this.thresholdInput.value<100||this.thresholdInput.value>5)&&"breath"===this.game.global.inputDevice)this.game.global.pressureEffort=parseInt(this.thresholdInput.value)/100,this.state.start("welcome");else if("keyboard_touch"===this.game.global.inputDevice)this.game.global.pressureEffort=null,this.state.start("welcome");else{this.thresholdInput.startFocus();var t=this.add.text(.5*this.camera.width,.8*this.camera.height,"Only integer values between 5 and 100 are valid for threshold",this.game.global.bodyStyleError);t.anchor.set(.5),this.time.events.add(3*Phaser.Timer.SECOND,function(){t.destroy()},this)}}}}),require.register("states/signup.js",function(e,t,i){i.exports={create:function(){var e=this,t=(this.add.sprite(0,0,"background_menu"),this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Signup",this.game.global.titleStyle));t.anchor.set(.5);var i=this.arrowBack=this.add.image(50,50,"arrowBack");i.anchor.set(.5,.5),i.scale.setTo(.6,.6),i.tint=this.game.global.primaryColorTint,i.inputEnabled=!0,i.input.useHandCursor=!0,i.events.onInputDown.add(function(){e.state.start("menu")},this),this.nameInput=this.add.inputField(this.world.centerX-140,this.world.centerY-50,{font:"20px Arial",width:250,padding:16,borderWidth:3,borderColor:"#2cc0ff",borderRadius:6,placeHolder:"Name"}),this.passwordInput=this.add.inputField(this.world.centerX-140,this.world.centerY+25,{font:"20px Arial",width:250,padding:16,borderWidth:3,borderColor:"#2cc0ff",borderRadius:6,placeHolder:"Password",type:PhaserInput.InputType.password});var s=this.errorMessage=this.add.text(this.world.centerX,.9*this.world.height,"Fill both fields please, they cannot be empty :)",{fill:"#ff3647"});s.anchor.set(.5),s.visible=!1;var a=this.checkLoginBtn=this.add.sprite(this.world.centerX,this.world.centerY+140,"button","blue_button04.png");a.anchor.set(.5,.5),a.inputEnabled=!0,a.input.useHandCursor=!0;var r=this.add.text(0,0,"Signup",this.game.global.buttonLabelStyle);r.anchor.set(.5,.5),a.addChild(r),a.events.onInputDown.add(function(){var t=this.nameInput.value,i=this.passwordInput.value;console.log("name: "+t+", pass: "+i),e.saveNewUser(t,i)},this)},startGame:function(){this.state.start("game")},saveNewUser:function(e,t){var i=this;if(e&&t){var s=new XMLHttpRequest;s.open("POST","https://duckieduck.herokuapp.com/api/users",!0),s.setRequestHeader("Content-Type","application/json;charset=UTF-8");var a=JSON.stringify({name:e,password:t});s.send(a),s.onreadystatechange=function(){if(s.readyState==XMLHttpRequest.DONE&&201==s.status){var e=JSON.parse(s.responseText);i.game.global.currentUser=e,i.state.start("welcome")}}}else i.errorMessage.visible=!0,i.time.events.add(3*Phaser.Timer.SECOND,function(){i.errorMessage.visible=!1},this)}}}),require.register("states/training_level.js",function(e,t,i){i.exports={create:function(){var e=this.world,t=this;this.speed=3;this.music=null,this.gameIsStopped=!1,this.pressure=null,this.rankingRetrieved=!1,this.scoreUpdated=!1,"breath"===this.game.global.inputDevice&&(this.socket=io.connect(window.location.hostname,{secure:!0,reconnect:!0,rejectUnauthorized:!1}),this.socket.on("connect",function(){console.log("client (game) connected to server"),t.socket.on("pc",function(e){t.pressure=parseFloat(e.p)})})),this.time.events.add(7.8*Phaser.Timer.SECOND,function(){t.music=t.sound.play("beethoven")},this),this.score=0,this.health=60,this.coinValue=10,this.gameOver=!1,this.physics.startSystem(Phaser.Physics.ARCADE),this.physics.arcade.gravity.y=500,this.enableCollision=!0;var i=this.background=this.add.tileSprite(0,0,e.width,e.height,"background");i.fixedToCamera=!0,this.map=this.game.add.tilemap("tilemap_training"),this.map.addTilesetImage("tiles_spritesheet","tiles"),this.map.addTilesetImage("Enemy","bee_tiles"),this.map.addTilesetImage("Arrows","arrows_tiles");var s=(this.scenarioLayer=this.map.createLayer("Scenario"),this.groundLayer=this.map.createLayer("Ground")),a=this.underwaterLayer=this.map.createLayer("Underwater");a.alpha=.7;this.specialBoxesLayer=this.map.createLayer("SpecialBoxes");this.map.setCollisionBetween(1,200,!0,"Scenario"),this.map.setCollisionBetween(1,200,!0,"Underwater"),this.map.setCollisionBetween(1,200,!0,"SpecialBoxes"),this.enemies=this.add.group(),this.enemies.enableBody=!0,this.map.createFromObjects("Enemies",157,"bee",0,!0,!1,this.enemies),this.enemies.callAll("animations.add","animations","fly",[0,2],10,!0),this.enemies.callAll("animations.play","animations","fly"),this.enemies.callAll("animations.add","animations","dead",[1],10,!0),this.enemies.setAll("body.allowGravity",!1),this.enemies.setAll("checkWorldBounds",!0),this.enemies.setAll("outOfBoundsKill",!0),this.enemies.forEach(function(e){t.add.tween(e.scale).to({x:1.2,y:1.2},480,Phaser.Easing.Back.InOut,!0,0,!1)}),this.coins=this.add.group(),this.coins.enableBody=!0,this.map.createFromObjects("Coins",161,"coin",0,!0,!1,this.coins),this.coins.callAll("animations.add","animations","spin",[0,1,2,3,4,5],10,!0),this.coins.callAll("animations.play","animations","spin"),this.coins.setAll("body.allowGravity",!1),this.arrows=this.add.group(),this.arrows.setAll("outOfBoundsKill",!0),this.arrows.setAll("checkWorldBounds",!0),this.map.createFromObjects("Arrows",166,"arrowUp",0,!0,!1,this.arrows),this.map.createFromObjects("Arrows",167,"arrowDown",0,!0,!1,this.arrows),this.scoreText=this.add.text(400,40,"score: 0",this.game.global.scoreTextStyle),this.scoreText.anchor.setTo(.5,.5),this.scoreText.fixedToCamera=!0,this.infoText=this.add.text(.5*this.camera.width,.3*this.camera.height,"Special boxes"),this.infoText.anchor.setTo(.5,.5),this.infoText.visible=!1,this.infoText.fixedToCamera=!0;var r=this.mouth=this.add.sprite(.4*this.camera.width,.4*this.world.height,"mouth");r.scale.setTo(.15,.15),r.anchor.setTo(.5,.5),r.fixedToCamera=!0;var n=this.nose=this.add.sprite(.4*this.camera.width,.52*this.world.height,"nose");n.scale.setTo(.15,.15),n.anchor.setTo(.5,.5),n.fixedToCamera=!0,this.mouthText=this.add.text(.56*this.camera.width,.4*this.world.height,"Jump and fly",{align:"left",boundsAlignH:"left",boundsAlignV:"middle"}),this.mouthText.anchor.setTo(.5,.5),this.mouthText.fixedToCamera=!0,this.noseText=this.add.text(.58*this.camera.width,.52*this.world.height,"Go under water",{align:"left",boundsAlignH:"left",boundsAlignV:"middle"}),this.noseText.anchor.setTo(.5,.5),this.noseText.fixedToCamera=!0,this.time.events.add(5*Phaser.Timer.SECOND,function(){this.switchAlphaInstructions([this.mouth,this.nose,this.mouthText,this.noseText])},this),this.hearts=this.add.group();for(var o=0;o<6;o++)this.hearts.create(50+45*o,40,"heartFull");this.hearts.forEach(function(e){e.anchor.setTo(.5,.5),e.scale.setTo(.7,.7)}),this.hearts.fixedToCamera=!0,this.breathingSensorCircle=this.add.graphics(0,0),this.breathingSensorCircle.beginFill(16711680,1),this.breathingSensorCircle.drawCircle(this.camera.width-100,40,25),this.breathingSensorCircle.fixedToCamera=!0,this.skipTrainingButton=this.add.sprite(.8*this.camera.width,.9*this.camera.height,"button","blue_button04.png"),this.skipTrainingButton.anchor.set(.5),this.skipTrainingButton.inputEnabled=!0,this.skipTrainingButton.input.useHandCursor=!0,this.playGameText=this.add.text(0,0,"Go to game",this.game.global.buttonLabelStyle),this.playGameText.anchor.set(.5),this.skipTrainingButton.addChild(this.playGameText),this.skipTrainingButton.fixedToCamera=!0,this.skipTrainingButton.events.onInputUp.add(function(){t.stopEverything(),t.state.start("game")}),this.overlayBackground=this.add.sprite(0,0,"overlay"),this.overlayBackground.x=.5*this.camera.width,this.overlayBackground.y=.5*this.camera.height,this.overlayBackground.anchor.set(.5,.5),this.overlayBackground.fixedToCamera=!0,this.overlayBackground.visible=!1,this.overlayText=this.add.text(.5*this.camera.width,.45*this.camera.height,"Text goes here",{align:"center",font:"bold 28px Arial",fill:"#fff"}),this.overlayText.anchor.set(.5,.5),this.overlayText.fixedToCamera=!0,this.overlayText.visible=!1,this.backToMenuBtn=this.add.sprite(.5*this.camera.width,.65*this.camera.height,"button","blue_button04.png"),this.backToMenuBtn.anchor.set(.5),this.backToMenuBtn.inputEnabled=!0,this.backToMenuBtn.input.useHandCursor=!0,this.backToMenuBtn.visible=!1,this.backToMenuText=this.add.text(0,0,"Back to main menu",this.game.global.buttonLabelStyle),this.backToMenuText.anchor.set(.5),this.backToMenuBtn.addChild(this.backToMenuText),this.backToMenuBtn.fixedToCamera=!0,this.backToMenuBtn.events.onInputUp.add(function(){t.stopEverything(),t.state.start("welcome")}),this.playGameBtn=this.add.sprite(.65*this.camera.width,.6*this.camera.height,"button","blue_button04.png"),this.playGameBtn.anchor.set(.5),this.playGameBtn.inputEnabled=!0,this.playGameBtn.input.useHandCursor=!0,this.playGameBtn.visible=!1,this.playGameText=this.add.text(0,0,"Play Game",this.game.global.buttonLabelStyle),this.playGameText.anchor.set(.5),this.playGameBtn.addChild(this.playGameText),this.playGameBtn.fixedToCamera=!0,this.playGameBtn.events.onInputUp.add(function(){t.state.start("game")}),this.practiceAgainBtn=this.add.sprite(.35*this.camera.width,.6*this.camera.height,"button","blue_button04.png"),this.practiceAgainBtn.anchor.set(.5),this.practiceAgainBtn.inputEnabled=!0,this.practiceAgainBtn.input.useHandCursor=!0,this.practiceAgainBtn.visible=!1,this.practiceAgainText=this.add.text(0,0,"Practice again",this.game.global.buttonLabelStyle),this.practiceAgainText.anchor.set(.5),this.practiceAgainBtn.addChild(this.practiceAgainText),this.practiceAgainBtn.fixedToCamera=!0,this.practiceAgainBtn.events.onInputUp.add(function(){t.switchAlphaInstructions([t.mouth,t.nose,t.mouthText,t.noseText]),t.state.restart()}),this.pauseButton=this.add.image(this.camera.width-40,40,"pauseButton"),this.pauseButton.scale.setTo(.1,.1),this.pauseButton.anchor.setTo(.5,.5),this.pauseButton.inputEnabled=!0,this.pauseButton.fixedToCamera=!0,this.pauseButton.events.onInputUp.add(function(){t.gameIsStopped?(t.displayOverlay("resumeGame"),t.gameIsStopped=!1):(t.displayOverlay("pause"),t.gameIsStopped=!0)});var h=this.endGameWall=this.add.sprite(this.world.width,0);this.physics.arcade.enable(h),h.body.collideWorldBounds=!0,h.width=10,h.height=this.world.height;var l=this.duck=this.add.sprite(80,e.centerY+60,"duck");l.anchor.setTo(.5,.5),this.physics.arcade.enable(l),l.body.collideWorldBounds=!0,l.scale.set(2),l.animations.add("walk",null,5,!0),l.animations.play("walk"),l.body.allowDrag=!0,l.body.drag.set(0,100),l.body.maxVelocity.set(200,400),this.camera.follow(l),this.camera.deadzone=new Phaser.Rectangle(0,0,100,400),"breath"===this.game.global.inputDevice&&(this.breathingBar=this.add.sprite(50,e.centerY,"bar"),this.breathingBar.anchor.set(0,.5),this.breathingBar.angle=90,this.breathingBar.scale.set(.2),this.breathingBar.fixedToCamera=!0,this.barHasBeenFlipped=!1);var d=this.add.text(80,.4*e.centerY,"Almost there! :)");d.anchor.set(.5);var c=this.duck2=this.add.sprite(80,.5*e.centerY,"duck");if(c.anchor.set(.5),c.scale.set(3),this.duckBounceTween(c),s.resizeWorld(),h.x=.97*this.world.width,d.x=.69*this.world.width,c.x=.69*this.world.width,"keyboard_touch"===this.game.global.inputDevice){var u=this.cursors=this.input.keyboard.createCursorKeys();u.down.onDown.add(function(){t.jump()}),u.up.onDown.add(function(){t.dive()}),this.swipe=this.game.input.activePointer}},update:function(){this.duck.body.velocity.x=60*this.speed,this.floatingWaterPhysics(),"breath"===this.game.global.inputDevice&&(this.updateSensorStatus(),this.updateBreathingBar()),this.gameOver?this.displayOverlay("gameOver"):this.background.tilePosition.x-=this.speed,this.physics.arcade.collide(this.duck,[this.scenarioLayer,this.underwaterLayer,this.enemies],this.duckCollision,this.duckProcessCallback,this),this.physics.arcade.collide(this.duck,this.specialBoxesLayer,this.hitSpecialBoxes,null,this),this.physics.arcade.overlap(this.duck,this.endGameWall,this.endGame,null,this),this.duck.y>this.world.centerY+60?this.duck.alpha=.3:this.duck.alpha=1,this.physics.arcade.overlap(this.duck,this.coins,this.collectCoin,null,this),"keyboard_touch"===this.game.global.inputDevice?(this.swipe.isDown&&this.swipe.positionDown.y>this.swipe.position.y?this.jump():this.swipe.isDown&&this.swipe.positionDown.y<this.swipe.position.y&&this.dive(),this.cursors.up.isDown?this.duck.body.acceleration.y=-1e3:this.cursors.down.isDown?this.duck.body.acceleration.y=800:this.duck.body.acceleration.y=0):"breath"===this.game.global.inputDevice?(this.pressure<this.game.global.currentUserCalibration.min*this.game.global.pressureEffort&&this.jump(),this.pressure>this.game.global.currentUserCalibration.max*this.game.global.pressureEffort&&this.dive(),this.pressure>this.game.global.currentUserCalibration.max*this.game.global.pressureEffort?this.duck.body.acceleration.y=-1e3:this.pressure<this.game.global.currentUserCalibration.min*this.game.global.pressureEffort?this.duck.body.acceleration.y=800:this.duck.body.acceleration.y=0):alert("Error in setting the input device, reload and check game settings!")},quit:function(){this.state.start("welcome")},duckProcessCallback:function(e,t){return this.enableCollision},duckCollision:function(e,t){if("bee"===t.key&&(t.animations.play("dead",10,!0),t.body.allowGravity=!0),e.body.blocked.down||e.body.blocked.up)console.log("Collision from above/below");else{this.health-=10,this.enableCollision=!1,this.duck.tint=16724787,this.add.tween(this.duck).to({angle:1440},1e3,Phaser.Easing.Linear.None,!0),this.add.tween(this.duck.scale).to({x:3,y:3},500,Phaser.Easing.Linear.None,!0).yoyo(!0);for(var i=this.hearts.length-1;i>0;i--){var s=this.hearts.getAt(i);if("heartFull"===s.key){s.loadTexture("heartEmpty");break}}0===this.health&&(this.gameOver=!0),this.time.events.add(3*Phaser.Timer.SECOND,this.resetPlayer,this)}},jump:function(){this.duck.body.y>this.world.centerY-35&&this.duck.body.y<this.world.height-70&&(this.duck.body.velocity.y=325)},dive:function(){this.duck.body.y<=this.world.centerY+60&&this.duck.body.y>100&&(this.duck.body.velocity.y=-325)},resetPlayer:function(){this.duck.tint=16777215,this.enableCollision=!0},collectCoin:function(e,t){this.score+=this.coinValue,this.scoreText.setText("score: "+this.score),t.destroy()},hitSpecialBoxes:function(e,t){var i=this;this.map.removeTile(t.x,t.y,this.specialBoxesLayer).destroy();var s=this.rnd.between(0,100);if(s>50)for(var a=0;a<this.hearts.length;a++){var r=this.hearts.getAt(a);if("heartEmpty"===r.key){r.loadTexture("heartFull"),this.health+=10,this.showAndRemoveText(this.infoText,"One heart recovered!");break}a===this.hearts.length-1&&this.showAndRemoveText(this.infoText,"Already had max health!")}else this.coinValue=20,this.time.events.add(5*Phaser.Timer.SECOND,function(){i.coinValue=10},this),this.showAndRemoveText(this.infoText,"All coins are double value for 5 seconds!"),this.coins.forEach(function(e){i.add.tween(e.scale).to({x:1.5,y:1.5},500,Phaser.Easing.Quadratic.InOut,!0)}),this.time.events.add(5*Phaser.Timer.SECOND,function(){this.coins.forEach(function(e){i.add.tween(e.scale).to({x:1,y:1},500,Phaser.Easing.Quadratic.InOut,!0)})},this)},showAndRemoveText:function(e,t){e.x=.5*this.camera.width,e.y=.3*this.camera.height,e.setText(t),e.visible=!0,this.time.events.add(5*Phaser.Timer.SECOND,function(){e.visible=!1},this)},switchAlphaInstructions:function(e){for(var t=0;t<e.length;t++)this.add.tween(e[t]).to({alpha:0},500,"Linear",!0)},displayOverlay:function(e){switch(this.overlayBackground.visible=!0,this.overlayText.visible=!0,this.stopEverything(),e){case"pause":this.overlayText.setText("Game paused, click the pause button to resume."),this.backToMenuBtn.visible=!0;break;case"gameOver":this.overlayText.setText("Great job! Play again?"),this.playGameBtn.visible=!0,this.practiceAgainBtn.visible=!0;break;case"gameEnd":this.overlayText.setText("Well done! Play again?"),this.playGameBtn.visible=!0,this.practiceAgainBtn.visible=!0;break;case"resumeGame":null!==this.music&&this.music.resume(),this.paused=!1,this.physics.arcade.isPaused=!this.physics.arcade.isPaused,this.overlayBackground.visible=!1,this.overlayText.visible=!1,this.backToMenuBtn.visible=!1;break;default:console.log("You are not supposed to be here...")}},stopEverything:function(){this.physics.arcade.isPaused=!0,this.paused=!0,null!==this.music&&this.music.isPlaying&&this.music.pause()},endGame:function(){this.displayOverlay("gameEnd")},updateSensorStatus:function(){null!==this.pressure?(this.breathingSensorCircle.clear(),this.breathingSensorCircle.beginFill(65280,1),this.breathingSensorCircle.drawCircle(this.camera.width-100,40,25)):(this.breathingSensorCircle.clear(),this.breathingSensorCircle.beginFill(16711680,1),this.breathingSensorCircle.drawCircle(this.camera.width-100,40,25))},updateBreathingBar:function(){this.breathingBar.tint=13421772,this.pressure>0?(this.barHasBeenFlipped&&(this.breathingBar.angle=270,this.barHasBeenFlipped=!1),this.breathingBar.width=100*this.pressure/1490,this.pressure>this.game.global.currentUserCalibration.max*this.game.global.pressureEffort&&(this.breathingBar.tint=65280)):(this.breathingBar.angle=90,this.barHasBeenFlipped=!0,this.breathingBar.width=Math.abs(100*this.pressure/-1800),this.pressure<this.game.global.currentUserCalibration.min*this.game.global.pressureEffort&&(this.breathingBar.tint=65280))},duckBounceTween:function(){var e=this;this.duck2.y=.5*this.camera.height+60;var t=this.add.tween(this.duck2);t.to({y:.25*this.camera.height-40},1500+1500*Math.random(),Phaser.Easing.Bounce.In),t.onComplete.add(function(){e.duckBounceTween()},this),t.start()},floatingWaterPhysics:function(){if(this.duck.body.y>this.world.centerY+60)this.physics.arcade.gravity.y=-1200;else if(this.duck.body.y<this.world.centerY+25&&this.duck.body.y>=this.world.centerY+20)this.physics.arcade.gravity.y=0;else if(this.duck.body.y<this.world.centerY+20)this.physics.arcade.gravity.y=1400;else{this.physics.arcade.gravity.y=-120;200*Math.abs(this.duck.body.velocity.y)/400+50}}}}),require.register("states/welcome.js",function(e,t,i){i.exports={create:function(){var e=this;console.log("pressureEffort var: "+this.game.global.pressureEffort+typeof this.game.global.pressureEffort),console.log("currentUser calibrations: ",this.game.global.currentUserCalibration);var t=new XMLHttpRequest;t.open("GET","https://duckieduck.herokuapp.com/api/users/"+this.game.global.currentUser.id,!0),t.onload=function(){var i=JSON.parse(t.responseText);4==t.readyState&&"200"==t.status?(console.log("taking calibration data of this user: ",i),i.calibrations.length?(e.game.global.currentUserCalibration.min=i.calibrations[0].max_inhale,e.game.global.currentUserCalibration.max=i.calibrations[0].max_exhale):alert("You have never done a calibration! Please go to the settings page (gear icon).")):console.error(i)},t.send(null);var i=(this.add.sprite(0,0,"background_menu"),this.add.text(this.game.global.titlePlacement.x,this.game.global.titlePlacement.y,"Welcome",this.game.global.titleStyle));i.anchor.set(.5),i.setText("Welcome, "+this.game.global.currentUser.name+"!");var s="In this game, you have to help Duckie Duck to collect as many coins\nas possible! During the game, you will see some special yellow boxes.\nSometimes they give you back a heart, sometimes they make the coins\ndouble their value for a limited time.\n\nThey say that Duckie Duck also likes music...",a=this.gameInstruction=this.add.text(.5*this.camera.width,.55*this.camera.height,s,this.game.global.bodyStyle);a.anchor.set(.5),console.log("gameInstructions: ",a);var r=this.settings=this.add.image(this.camera.width-90,50,"gear");r.scale.setTo(.6,.6),r.tint=this.game.global.primaryColorTint,r.inputEnabled=!0,r.input.useHandCursor=!0,r.events.onInputDown.add(function(){this.settingsPage()},this);var n=this.leaderboard=this.add.image(this.camera.width-160,50,"leaderboard");n.scale.setTo(.6,.6),n.tint=this.game.global.primaryColorTint,n.inputEnabled=!0,n.input.useHandCursor=!0,n.events.onInputDown.add(function(){this.leaderboardPage()},this);var o=this.startBtn=this.add.sprite(.5*this.camera.width,.85*this.camera.height,"button","blue_button04.png");o.anchor.set(.5,.5),o.inputEnabled=!0,o.input.useHandCursor=!0;var h=this.add.text(0,0,"Start",this.game.global.buttonLabelStyle);h.anchor.set(.5,.5),o.addChild(h),o.events.onInputDown.add(function(){this.startGame()},this)},startGame:function(){this.state.start("training_level")},settingsPage:function(){this.state.start("settings")},leaderboardPage:function(){this.state.start("ranking")}}}),require.register("___globals___",function(e,t,i){})}(),require("___globals___"),require("initialize");